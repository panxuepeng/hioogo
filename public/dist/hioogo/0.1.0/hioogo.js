/* 2013-10-08 */
define("hioogo/0.1.0/common",["./config","bootstrap/2.3.2/bootstrap","events/1.1.0/events"],function(a,b){function c(){$.getJSON(f.serverLink("user"),function(a){b.checkLogin(a)}),$("#user-logout").on("click",function(){return $.getJSON(f.serverLink("logout"),function(a){200===a[0]&&b.checkLogin([0])}),!1}),$("footer").html(e())}function d(a){var b=Math.ceil(a.height()),c=$(document).scrollTop(),d=c-b,e=c+$(window).height(),f=a.offset().top;return f>d&&e>f}function e(){var a='<p>&copy;2013 <a href="/?about">关于看自然</a> Powered by KanZiRan</p><p>Thanks <a href="http://twitter.github.com/bootstrap/" target="_blank" title="基于HTML，CSS，JAVASCRIPT的简洁灵活的前端框架及交互组件集">Bootstrap</a><a href="http://jquery.com/" target="_blank" title="一个优秀的JavaScrīpt框架。使用户能更方便地处理HTML documents、events、实现动画效果，并且方便地为网站提供AJAX交互">jQuery</a><a href="http://seajs.org/" target="_blank" title="SeaJS 是一个适用于 Web 端的模块加载器">SeaJS</a><a href="http://www.plupload.com/" target="_blank" title="一款基于 Flash、HTML5 的文件上传工具，其最大的特点是，在浏览器端压缩图片后会保留照片的Exif信息">Plupload</a><a href="https://github.com/aui/artTemplate" target="_blank" title="一款性能卓越的 javascript 模板引擎">artTemplate</a></p>';return a}var f=a("./config"),g=(a("bootstrap/2.3.2/bootstrap"),a("events/1.1.0/events"));g.mixTo(b),b.init=c,b.checkLogin=function(a){var b=f.pages;if(200===a[0])f.logined=!0,f.cache.reset(),$("#user-login").fadeOut(100,function(){setTimeout(function(){$("#create-topic").show()},200)});else{$("#user-login").show(),$("#create-topic").hide();for(var c in b)c===f.action&&2===b[c]&&(location=f.home())}},b.alert=function(a){var c=$("#dialog");c.children(".modal-body").html(a),b.dialog()};var h={title:"提示",width:560,content:"",backdrop:!0,keyboard:!0,show:!0,onshown:null,onok:function(){b.dialog.close()}};b.dialog=function(a){a=a||{};var b=$("#dialog");a=$.extend({},h,a),b.width(a.width),b.find(".modal-header h3").html(a.title),b.find(".modal-body").html(a.content),b.modal(a),b.off("shown"),$.isFunction(a.onshown)&&b.on("shown",function(){a.onshown(b)}),$.isFunction(a.onok)&&b.find("a[name=onok]").off("click").on("click",function(){return a.onok(b),!1})},b.dialog.close=function(){$("#dialog").modal("hide")},b.on("afterinit",function(){i()});var i=function(){var a,b=$("#topic-title");a=b.is(":visible")?'<li><a href="#/photolist">最新照片</a></li><li class="active"><span class="divider">/</span> '+b.text()+"</li>":"<li>最新照片</li>",$("#breadcrumb").html(a)};b.lazyload=function(){var a;$(window).bind("scroll.lazyload resize.lazyload",function(){clearTimeout(a),a=setTimeout(function(){$("div[data-src], li[data-src], img[data-src]").each(function(){var a=$(this);d(a)&&(a.is("img")?a.attr("src",a.attr("data-src")):a.css("background-image","url("+a.attr("data-src")+")"),a.removeAttr("data-src"))})},200)})}}),define("hioogo/0.1.0/config",[],function(a,b){var c="http://localhost:8080/";b.version="0.1.0",b.base=c,b.cache={reset:function(){this.topic={},this.topiclist={}},topic:{},topiclist:{}},b.logined=!1,b.player="default.player",b.index="photolist",b.action="photolist",b.timestamp=+new Date,b.commonScript=[],b.pages={photo:1,photolist:1,login:1,center:1,setting:1,post:2,center:2},b.actionVersion={},b.tmplVersion={},b.go=function(a){location=a},b.home=function(){return"/#/photolist"},b.hashLink=function(a){return"/#/"+a},b.link=function(a){return"/#/"+a},b.serverLink=function(a){return"/"+a},b.getTmplPath=function(a){var d=b.tmplVersion,e=c+"/tmpl/"+a+".html".replace(/[\/]+/g,"/");return seajs.debug?e+="?"+new Date:d[a]&&(e+="?"+d[a]),e}}),define("hioogo/0.1.0/hioogo",["./config","./common","bootstrap/2.3.2/bootstrap","events/1.1.0/events"],function(a){function b(a){var b=e();g.action=b,k[b]?(l("#container").children(":visible").hide(),l("#row-"+b).show(),l.isFunction(k[b].show)&&k[b].show(i[1])):seajs.use("./dist/hioogo/"+g.version+"/controller/"+b,function(a){l.get(g.getTmplPath(a.tmpl||b),function(b){l("#container").children(":visible").hide(),l("#container").append(b),l.isFunction(a.init)&&a.init(i[1]),l.isFunction(a.show)&&a.show(i[1])}),k[b]=a}),l.isFunction(a)&&a()}function c(){var a=g.pages;for(var b in a)b!==g.action&&l.get(g.getTmplPath(b))}function d(a){"!"===a.substr(0,1)&&(a=a.slice(1)),a&&"/"===a.substr(0,1)&&(a=a.slice(1));var b=a.split("/");return b}function e(){var a,b,c,e=location.hash.slice(1).replace("?","&");if(e){a=e.split("&"),i=d(a[0]),c=i[0];for(var f=1,h=a.length;h>f;f+=1)b=a[f].split("="),j[b[0]]=b[1]}return c&&g.pages[c]||(c=g.index),c}function f(a){for(var b=0,c=a.length;c>b;b+=1)l.ajax({url:a[b],dataType:"script",cache:"true"})}var g=a("./config"),h=a("./common"),i=[],j={},k={},l=window.jQuery;f(g.commonScript),b(function(){h.init(),setTimeout(function(){c()},500)}),l(window).bind("hashchange",function(){b()}),l(document).delegate("[data-on]","click",function(){var a=l(this),b=a.data("on");k[g.action]["on-"+b](a)})}),define("hioogo/0.1.0/controller/center",["md5/1.0.0/md5","../config","../common","bootstrap/2.3.2/bootstrap","events/1.1.0/events","arttemplate/2.0.1/arttemplate","validator/1.2.0/validator"],function(a,b){function c(){function a(a){$.ajax({url:e.serverLink("center/profile"),type:"PUT",data:a,dataType:"json",success:function(a){var b=$("#center-alert");200===a[0]?b.removeClass("alert-error").addClass("alert-success"):b.removeClass("alert-success").addClass("alert-error"),$("#center-msg").html(a[1]),b.show()},error:function(){alert("提交失败，请稍候再试")},complete:function(){f=!1}})}function b(a){$.ajax({url:e.serverLink("center/password"),type:"PUT",data:a,dataType:"json",success:function(a){var b=$("#center-alert");200===a[0]?b.removeClass("alert-error").addClass("alert-success"):b.removeClass("alert-success").addClass("alert-error"),$("#center-msg").html(a[1]),b.show()},error:function(){alert("提交失败，请稍候再试")},complete:function(){f=!1}})}function c(a){$.ajax({url:e.serverLink("center/questions"),type:"PUT",data:a,dataType:"json",success:function(a){var b=$("#center-alert");200===a[0]?b.removeClass("alert-error").addClass("alert-success"):b.removeClass("alert-success").addClass("alert-error"),$("#center-msg").html(a[1]),b.show()},error:function(){alert("提交失败，请稍候再试")},complete:function(){f=!1}})}$(".control-group").mouseenter(function(){var a=$(this);a.hasClass("error")||a.addClass("focus")}).mouseleave(function(){$(this).removeClass("focus")});var f=!1;$("#center-profile").validator({after:function(){if(f)return!1;var b=$(this).serializeArray(),c={};return $.each(b,function(a,b){c[b.name]=b.value}),f=!0,a(c),!1},errorCallback:function(a){f=!1,"object"==typeof console&&(console.log("验证失败的表单："),console.log(a))}}),$("#center-password input").attr("required","true").data("parent",".control-group"),$("#center-password").validator({after:function(){if(f)return!1;var a=$(this).serializeArray(),c={};return $.each(a,function(a,b){c[b.name]=d($.trim(b.value))}),f=!0,b(c),!1},errorCallback:function(a){f=!1,"object"==typeof console&&(console.log("验证失败的表单："),console.log(a))}}),$("#center-questions").validator({after:function(){if(f)return!1;var a=$(this).serializeArray();return f=!0,c(a),!1},errorCallback:function(a){f=!1,"object"==typeof console&&(console.log("验证失败的表单："),console.log(a))}})}var d=a("md5/1.0.0/md5"),e=a("../config"),f=(a("../common"),a("arttemplate/2.0.1/arttemplate")),d=a("md5/1.0.0/md5");a("validator/1.2.0/validator"),b.show=function(a){a=a||"profile",$("#row-center form, #center-alert").hide(),$("#center-"+a).show(),$("#row-center .sidenav li.active").removeClass("active"),$("#row-center .sidenav a[href*="+a+"]").closest("li").addClass("active")},b.init=function(a){a=a||"profile",$.getJSON(e.serverLink("user"),function(b){if(200===b[0]){var d=b[1].questions;d.q1=d.q1||"",d.a1=d.a1||"",d.q2=d.q2||"",d.a2=d.a2||"";var e=f.render("tmpl-center",b[1]);$("#center").html(e),setTimeout(function(){$("#row-center form").hide(),$("#center-"+a).show(),c()},0)}})}}),define("hioogo/0.1.0/controller/login",["md5/1.0.0/md5","../config","../common","bootstrap/2.3.2/bootstrap","events/1.1.0/events"],function(a,b){var c=a("md5/1.0.0/md5"),d=a("../config"),e=a("../common");b.show=function(){},b.init=function(){$("form[name=login]").on("submit",function(){var a,b=$(this),f=b.find(":password[name=password]"),g=$.trim(f.val());return f.val(c(g)),a=b.serialize(),f.val(g),$.post(d.serverLink("login"),a,function(a){200===a[0]?(location=d.home(),e.checkLogin(a)):alert(a[1])},"json").error(function(a,b){alert(b)}),!1})}}),define("hioogo/0.1.0/controller/photo",["../config","../common","bootstrap/2.3.2/bootstrap","events/1.1.0/events","arttemplate/2.0.1/arttemplate"],function(a,b){function c(a){var b="";a&&"object"==typeof a&&(b=i.render("tmpl-photoview",a)),$("#photoview").html(b),setTimeout(function(){h.init()},0),g.trigger("afterinit")}function d(a){var b=a.closest(".thumbnail").find("img"),c=b.attr("src"),d=b.attr("photoid"),e=b.attr("shooting_time"),f=b.attr("description");return{photosrc:c,topicid:j,photoid:d,shooting_time:e,description:f}}function e(a){var b=a.find("form").serialize(),c=a.find(":hidden[name=photoid]").val(),d=f.serverLink("photos/"+c);$.ajax({type:"PUT",data:b,dateType:"json",url:d}).success(function(b){if(200===b[0]){var d=a.find("textarea").val();$("img[photoid="+c+"]").attr("description",d),$("#description-"+c).text(d),g.dialog.close()}else alert(b[1])}).error(function(){alert("出现错误，请稍候再试。")})}var f=a("../config"),g=a("../common"),h=null,i=a("arttemplate/2.0.1/arttemplate"),j="",k=$(document);a.async("../player/"+f.player,function(a){h=a}),b.show=function(a){a=a||1,j=a,f.cache.topic[a]?c(f.cache.topic[a]):$.getJSON(f.serverLink("topics/"+a),function(a){200===a[0]?(c(a[1]),f.cache.topic[j]=a[1]):seajs.log(a)})},b["on-photoedit"]=function(a){var b=i.render("tmpl-photo-edit",d(a));g.dialog({title:"编辑照片描述",width:600,content:b,onshown:function(a){var b=a.find("textarea");$.trim(b.val())||b.focus()},onok:function(a){e(a)}})},b["on-topicedit"]=function(){location="/#/post/"+j},b["on-topicremove"]=function(){if(confirm("确认删除此主题和其所有照片吗？")){var a=f.serverLink("topics/"+j);$.ajax({type:"DELETE",dateType:"json",url:a}).success(function(a){200===a[0]?(f.cache.topic[j]=null,f.go(f.home())):alert(a[1])}).error(function(){alert("出现错误，请稍候再试。")})}},b["on-topicrecommend"]=function(){var a=f.serverLink("topics/"+j);$.ajax({type:"PUT",dateType:"json",url:a}).success(function(a){200===a[0]||alert(a[1])}).error(function(){alert("出现错误，请稍候再试。")})},b["on-photoremove"]=function(a){if(confirm("确认彻底删除此照片吗？")){var b=a.closest("li[id^=photo]");b.hide();var c=f.serverLink("photos/"+a.attr("photoid"));$.ajax({type:"DELETE",dateType:"json",url:c}).success(function(a){200===a[0]||(alert(a[1]),b.show())}).error(function(){alert("出现错误，请稍候再试。"),b.show()})}},b.init=function(){k.on("mouseover.photo",".thumbnail",function(){$(this).find(".photo_edit").show()}).on("mouseleave.photo",".thumbnail",function(){$(this).find(".photo_edit").hide()}),g.lazyload()}}),define("hioogo/0.1.0/controller/photolist",["../config","arttemplate/2.0.1/arttemplate","../common","bootstrap/2.3.2/bootstrap","events/1.1.0/events"],function(a,b){function c(a){var b="";b=e.render("tmpl-photolist",a),$("#photolist").html(b),a.pageCount&&$("#pagination").pagination(a.topicCount,{items_per_page:12,num_display_entries:10,current_page:0,num_edge_entries:1,link_to:"javascript:void(0)",prev_text:"上一页",next_text:"下一页",ellipse_text:"...",prev_show_always:!0,next_show_always:!0,callback:function(a){location=d.link("photolist/"+a)}}).show(),f.trigger("afterinit")}var d=a("../config"),e=a("arttemplate/2.0.1/arttemplate"),f=a("../common");b.tmpl="photolist",b.show=function(){d.cache.topiclist.news?c(d.cache.topiclist.news):$.getJSON(d.serverLink("topics"),function(a){if($.isArray(a)&&200===a[0]){var b={list:a[1]};c(b),d.cache.topiclist.news=b}else seajs.log(a)})},b.init=function(){}}),define("hioogo/0.1.0/controller/post",["plupload/1.5.6/plupload","../common","../config","bootstrap/2.3.2/bootstrap","events/1.1.0/events"],function(a,b){function c(a){var b=$("form[name=post]");b.find("input[name=topicid]").val(a._id),b.find("input[name=title]").val(a.title),b.find("textarea[name=description]").val(a.description);for(var c=[],d=a.photos,e=0,f=d.length;f>e;e++){var g=d[e];c.push('<div class="span2"><img src="'+g.url+'" photo_id="'+g._id+'"/></div>')}$("#uploadlist").html(c.join("")),$("#post-submit").attr({disabled:!1,title:""})}a("plupload/1.5.6/plupload");var d,e=a("../common"),f=a("../config");b.show=function(a){var b=$("form[name=post]");a?(b.find("legend").text("编辑照片主题"),f.cache.topic[a]?c(f.cache.topic[a]):$.getJSON(f.serverLink("topics/"+a),function(a){200===a[0]?a[1].isauthor?c(a[1]):location="/#/post":seajs.log(a)})):(b.find("legend").text("创建照片主题"),g.reset())},b.init=function(){d||h.init(),g.init()};var g={init:function(){var a=this;$("form[name=post]").on("submit",function(){var b=$(this),c={};if(a.check(b)){c.topicid=$.trim(b.find("input[name=topicid]").val()),c.title=$.trim(b.find("input[name=title]").val()),c.description=$.trim(b.find("textarea[name=description]").val()),c.photoList=[],$("img[photo_id]").each(function(){c.photoList.push($(this).attr("photo_id"))}),c.cover_photo=$("#uploadlist img").eq(0).attr("src");var d="POST",e=f.serverLink("topics");c.topicid&&(d="PUT",e=f.serverLink("topics/"+c.topicid)),$.ajax({type:d,dateType:"json",url:e,data:c}).success(function(b){if(200===b[0]){var c=b[1].topicid;a.success(c),f.cache.topic[c]=null}else a.error(b[1])}).error(function(){alert("出现错误，请稍候再试。")})}return!1}),$("button[name=post-reset]").on("click",function(){location="/#/post",g.reset()})},check:function(a){return $.trim(a.find(":text[name=title]").val())?$("#uploadlist img").length?!0:(alert("还没有上传任何图片"),!1):(alert("请输入标题"),a.find(":text[name=title]").focus(),!1)},success:function(a){$("#post-submit").attr({disabled:!0,title:""}).text("提交成功！再次选择照片后，可以继续提交"),$("form[name=post]").find("input[name=topicid]").val(a);var b=$("#post-success");b.find("a[name=view]").attr("href","#/photo/"+a),b.show(),i.clear()},error:function(a){"string"==typeof a&&e.alert("<p>"+a+"</p>")},reset:function(){i.clear(),$("form[name=post]")[0].reset(),$("form[name=post]").find("input[name=topicid]").val(""),$("#filelist").empty(),$("#uploadlist").empty(),d&&d.splice(0,d.files.length),$("#post-submit").attr({disabled:!0,title:"请选择照片……"}).text("提 交"),$("#post-success").hide()}};$("button[name=post-reset]").on("click",function(){return g.reset(),!1});var h={init:function(){var a=this;d=new plupload.Uploader({runtimes:"flash, html5",file_data_name:"photo",browse_button:"pickfiles",url:f.serverLink("photos"),flash_swf_url:"dist/plupload/1.5.6/plupload.flash.swf",filters:[{title:"Image files",extensions:"jpg"}],max_file_size:"10mb",resize:{width:1e3,height:1e3,quality:95}}),d.bind("Init",function(){$("#filelist").html("")}),d.init(),d.bind("FilesAdded",function(b,c){a.selected(c),d.start(),b.refresh(),i.set()}),d.bind("UploadProgress",function(b,c){a.progress(c)}),d.bind("FileUploaded",function(b,c,d){a.uploadedOne(c,d)}),d.bind("UploadComplete",function(b,c){a.complete(c)})},selected:function(a){$("#post-success").hide(),$("#post-submit").attr({disabled:!0,title:""}).text("正在上传图片，暂时不能提交"),$("#filelist").html(" 选择了 <b>"+a.length+'</b> 张图片，正在上传第 <b id="FileUploaded">0</b> 张，进度 <b id="UploadProgress">0</b>%')},progress:function(a){$("#UploadProgress").html(a.percent)},uploadedOne:function(a,b){var c=$("#FileUploaded"),d=parseInt(c.text(),10)+1;c.text(d);var e=$.parseJSON(b.response);$("#uploadlist").append('<div class="span2"><img src="'+e.url+'" photo_id="'+e.id+'"/></div>')},complete:function(a){$("#filelist").html(" 已上传 <b>"+a.length+"</b> 张图片"),$("#post-submit").attr({disabled:!1,title:""}).text(" 提 交 ")}},i={set:function(a){return a=a||"确定要离开吗？","function"==typeof window.onbeforeunload?!1:(window.onbeforeunload=function(b){return b=b||window.event,b.returnValue=a,a},!0)},clear:function(){window.onbeforeunload=null}}}),define("hioogo/0.1.0/controller/setting",["md5/1.0.0/md5","../config","../common","bootstrap/2.3.2/bootstrap","events/1.1.0/events"],function(a,b){a("md5/1.0.0/md5"),a("../config"),a("../common"),b.show=function(){},b.init=function(){}}),define("hioogo/0.1.0/player/default.player",["../common","../config","bootstrap/2.3.2/bootstrap","events/1.1.0/events"],function(a,b){function c(){$("#player .photo").height(m.height()-20)}function d(a){var b=$("#photo-"+a),c=b.attr("src").replace("/270/","/970/"),d=$("#player-photo"),g=d.height(),j=b.attr("description")||'<span style="color:#eeeeef;">暂无照片描述</span>';if(d.css({"background-position-y":0}),f=null,l.off("mousewheel.bigphoto"),$("#player").removeClass("hide"),$("#player-desc").html("<h4>"+$("#topic-title").text()+"</h4>"+j),$("#player-shooting-time").html(b.attr("shooting_time")),h[c]){var m=h[c];if(l.on("mousewheel.bigphoto",function(a){e(a.originalEvent.wheelDelta)}),d.css("background-image","url("+c+")"),m.height>g+100){k=!0;var n=(g-m.height)/2;d.animate({"background-position-y":n},3e3,function(){f=m,k=!1})}}else{var b=new Image;b.index=a,b.onload=function(){if(i===b.index&&(f={height:b.height,width:b.width},l.on("mousewheel.bigphoto",function(a){e(a.originalEvent.wheelDelta)}),d.css("background-image","url("+c+")"),b.height>g+100)){var a=(g-b.height)/2;k=!0,d.animate({"background-position-y":a},3e3,function(){k=!1})}h[c]={height:b.height,width:b.width},b=null},b.src=c}}function e(a){if(!k){var b=$("#player .photo"),c=b.height(),d=60,e=parseInt(b.css("backgroundPositionY")||0,10);e||(e=parseInt(b.css("backgroundPosition").split(" ")[1],10)),a>0?e-=d:e+=d,e>c?e=c:e<-f.height&&(e=-f.height),b.css({backgroundPositionY:e})}return!1}var f,g=a("../common"),h={},i=0,j=0,k=0,l=$(document),m=$(window);l.on("click","#player-close",function(){$("body").css("overflow","visible"),$("#player").addClass("hide"),f=null,l.off("mousewheel.bigphoto"),$("#player .photo").stop().stop().stop()}),l.on("click","#player-prev",function(){b.prev()}),l.on("click","#player-next",function(){b.next()}),l.on("click","img[name=photoview]",function(){i=parseInt($(this).attr("index"),10),$("body").css({overflow:"hidden"}),setTimeout(function(){d(i)},0)}),l.on("click","#player",function(){$("#player .photo").stop().stop().stop(),k=!1}),m.resize(function(){c()}),m.keydown(function(a){var c=a.keyCode;switch(c){case 37:b.prev();break;case 39:b.next();break;case 38:b.up();break;case 40:b.down();break;case 27:b.close()}}),b.close=function(){$("#player").addClass("hide")},b.init=function(){c(),j=$("img[name=photoview]").size()},b.prev=function(){$("#player .photo").stop().stop().stop(),i-=1,0>i?(i=0,g.dialog({content:"已经是第一张照片了"})):d(i)},b.next=function(){$("#player .photo").stop().stop().stop(),i+=1,j>i?d(i):g.dialog({content:"已经是最后一张照片了"})},b.up=function(){e(10)},b.down=function(){e(-10)}});